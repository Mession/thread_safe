<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: ThreadSafe::AtomicReferenceCacheBackend::Node
  
    &mdash; Concurrent
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../../';
  framesUrl = "../../frames.html#!ThreadSafe/AtomicReferenceCacheBackend/Node.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../../_index.html">Index (N)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../ThreadSafe.html" title="ThreadSafe (module)">ThreadSafe</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../AtomicReferenceCacheBackend.html" title="ThreadSafe::AtomicReferenceCacheBackend (class)">AtomicReferenceCacheBackend</a></span></span>
     &raquo; 
    <span class="title">Node</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: ThreadSafe::AtomicReferenceCacheBackend::Node
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">ThreadSafe::AtomicReferenceCacheBackend::Node</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
      <dt class="r2">Extended by:</dt>
      <dd class="r2"><span class='object_link'><a href="../Util/Volatile.html" title="ThreadSafe::Util::Volatile (module)">Util::Volatile</a></span></dd>
      
    
  
    
      <dt class="r1">Includes:</dt>
      <dd class="r1"><span class='object_link'><a href="../Util/CheapLockable.html" title="ThreadSafe::Util::CheapLockable (module)">Util::CheapLockable</a></span></dd>
      
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">lib/thread_safe/atomic_reference_cache_backend.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>Key-value entry. Nodes with a hash field of +MOVED+ are special, and do
not contain user keys or values. Otherwise, keys are never +nil+, and
+NULL+ +value+ fields indicate that a node is in the process of being
deleted or created. For purposes of read-only access, a key may be read
before a value, but can only be used after checking value to be +!= NULL+.</p>


  </div>
</div>
<div class="tags">
  

</div>
  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="MOVED-constant" class="">MOVED =
          <div class="docstring">
  <div class="discussion">
    <p>Encodings for special uses of Node hash fields. See above for explanation.</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>10</span><span class='tstring_end'>&#39;</span></span> <span class='op'>&lt;&lt;</span> <span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>0</span><span class='tstring_end'>&#39;</span></span> <span class='op'>*</span> <span class='id identifier rubyid_bit_shift'>bit_shift</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='lparen'>(</span><span class='int'>2</span><span class='rparen'>)</span></pre></dd>
      
        <dt id="LOCKED-constant" class="">LOCKED =
          <div class="docstring">
  <div class="discussion">
    <p>set/tested only as a bit</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>01</span><span class='tstring_end'>&#39;</span></span> <span class='op'>&lt;&lt;</span> <span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>0</span><span class='tstring_end'>&#39;</span></span> <span class='op'>*</span> <span class='id identifier rubyid_bit_shift'>bit_shift</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='lparen'>(</span><span class='int'>2</span><span class='rparen'>)</span></pre></dd>
      
        <dt id="WAITING-constant" class="">WAITING =
          <div class="docstring">
  <div class="discussion">
    <p>both bits set/tested together</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>11</span><span class='tstring_end'>&#39;</span></span> <span class='op'>&lt;&lt;</span> <span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>0</span><span class='tstring_end'>&#39;</span></span> <span class='op'>*</span> <span class='id identifier rubyid_bit_shift'>bit_shift</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='lparen'>(</span><span class='int'>2</span><span class='rparen'>)</span></pre></dd>
      
        <dt id="HASH_BITS-constant" class="">HASH_BITS =
          <div class="docstring">
  <div class="discussion">
    <p>usable bits of normal node hash</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>00</span><span class='tstring_end'>&#39;</span></span> <span class='op'>&lt;&lt;</span> <span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1</span><span class='tstring_end'>&#39;</span></span> <span class='op'>*</span> <span class='id identifier rubyid_bit_shift'>bit_shift</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='lparen'>(</span><span class='int'>2</span><span class='rparen'>)</span></pre></dd>
      
        <dt id="SPIN_LOCK_ATTEMPTS-constant" class="">SPIN_LOCK_ATTEMPTS =
          
        </dt>
        <dd><pre class="code"><span class='const'>Util</span><span class='op'>::</span><span class='const'>CPU_COUNT</span> <span class='op'>&gt;</span> <span class='int'>1</span> <span class='op'>?</span> <span class='const'>Util</span><span class='op'>::</span><span class='const'>CPU_COUNT</span> <span class='op'>*</span> <span class='int'>2</span> <span class='op'>:</span> <span class='int'>0</span></pre></dd>
      
    </dl>
  




  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#key-instance_method" title="#key (instance method)">- (Object) <strong>key</strong> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns the value of attribute key.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#attr_volatile-class_method" title="#attr_volatile (class method)">+ (Object) <strong>attr_volatile</strong>(*attr_names) </a>
    

    
  </span>
  
    <span class="note title not_defined_here">
      extended
      from <span class='object_link'><a href="../Util/Volatile.html#attr_volatile-class_method" title="ThreadSafe::Util::Volatile#attr_volatile (method)">Util::Volatile</a></span>
    </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Provides +volatile+ (in the JVM&#39;s sense) attribute accessors implemented atop of the +AtomicReference+s.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#locked_hash%3F-class_method" title="locked_hash? (class method)">+ (Boolean) <strong>locked_hash?</strong>(hash) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (Node) <strong>initialize</strong>(hash, key, value, next_node = nil) </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>A new instance of Node.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#key%3F-instance_method" title="#key? (instance method)">- (Boolean) <strong>key?</strong>(key) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#locked%3F-instance_method" title="#locked? (instance method)">- (Boolean) <strong>locked?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#matches%3F-instance_method" title="#matches? (instance method)">- (Boolean) <strong>matches?</strong>(key, hash) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#pure_hash-instance_method" title="#pure_hash (instance method)">- (Object) <strong>pure_hash</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#try_await_lock-instance_method" title="#try_await_lock (instance method)">- (Object) <strong>try_await_lock</strong>(table, i) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Spins a while if +LOCKED+ bit set and this node is the first of its bin, and then sets +WAITING+ bits on hash field and blocks (once) if they are still set.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#try_lock_via_hash-instance_method" title="#try_lock_via_hash (instance method)">- (Object) <strong>try_lock_via_hash</strong>(node_hash = hash) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#unlock_via_hash-instance_method" title="#unlock_via_hash (instance method)">- (Object) <strong>unlock_via_hash</strong>(locked_hash, node_hash) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  
  
  
  <div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="ThreadSafe::AtomicReferenceCacheBackend::Node (class)">Node</a></span></tt>) <strong>initialize</strong>(hash, key, value, next_node = nil) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns a new instance of Node</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


243
244
245
246
247
248
249</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/thread_safe/atomic_reference_cache_backend.rb', line 243</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='comma'>,</span> <span class='id identifier rubyid_next_node'>next_node</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>super</span><span class='lparen'>(</span><span class='rparen'>)</span>
  <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_lazy_set_hash'>lazy_set_hash</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_lazy_set_value'>lazy_set_value</span><span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_next'>next</span> <span class='op'>=</span> <span class='id identifier rubyid_next_node'>next_node</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="key-instance_method">
  
    - (<tt>Object</tt>) <strong>key</strong>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns the value of attribute key</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


241
242
243</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/thread_safe/atomic_reference_cache_backend.rb', line 241</span>

<span class='kw'>def</span> <span class='id identifier rubyid_key'>key</span>
  <span class='ivar'>@key</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="attr_volatile-class_method">
  
    + (<tt>Object</tt>) <strong>attr_volatile</strong>(*attr_names) 
  

  

  
    <span class="not_defined_here">
      Originally defined in module
        <span class='object_link'><a href="../Util/Volatile.html#attr_volatile-class_method" title="ThreadSafe::Util::Volatile#attr_volatile (method)">Util::Volatile</a></span>
    </span>
  
</h3><div class="docstring">
  <div class="discussion">
    <p>Provides +volatile+ (in the JVM&#39;s sense) attribute accessors implemented atop of the +AtomicReference+s.
Usage:
  class Foo
    extend ThreadSafe::Util::Volatile
    attr_volatile :foo, :bar</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_bar'>bar</span><span class='rparen'>)</span>
  <span class='kw'>super</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='comment'># must super() into parent initializers before using the volatile attribute accessors
</span>  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_bar'>bar</span> <span class='op'>=</span> <span class='id identifier rubyid_bar'>bar</span>
<span class='kw'>end</span>

<span class='kw'>def</span> <span class='id identifier rubyid_hello'>hello</span>
  <span class='id identifier rubyid_my_foo'>my_foo</span> <span class='op'>=</span> <span class='id identifier rubyid_foo'>foo</span> <span class='comment'># volatile read
</span>  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_foo'>foo</span> <span class='op'>=</span> <span class='int'>1</span> <span class='comment'># volatile write
</span>  <span class='id identifier rubyid_cas_foo'>cas_foo</span><span class='lparen'>(</span><span class='int'>1</span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span> <span class='comment'># =&gt; true | a strong CAS
</span><span class='kw'>end</span>
</code></pre>

<p>end</p>


  </div>
</div>
<div class="tags">
  

</div>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="locked_hash?-class_method">
  
    + (<tt>Boolean</tt>) <strong>locked_hash?</strong>(hash) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


326
327
328</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/thread_safe/atomic_reference_cache_backend.rb', line 326</span>

<span class='kw'>def</span> <span class='id identifier rubyid_locked_hash?'>locked_hash?</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='rparen'>)</span>
  <span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span> <span class='op'>&amp;</span> <span class='const'>LOCKED</span><span class='rparen'>)</span> <span class='op'>!=</span> <span class='int'>0</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="key?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>key?</strong>(key) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


281
282
283</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/thread_safe/atomic_reference_cache_backend.rb', line 281</span>

<span class='kw'>def</span> <span class='id identifier rubyid_key?'>key?</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
  <span class='ivar'>@key</span><span class='period'>.</span><span class='id identifier rubyid_eql?'>eql?</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="locked?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>locked?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


303
304
305</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/thread_safe/atomic_reference_cache_backend.rb', line 303</span>

<span class='kw'>def</span> <span class='id identifier rubyid_locked?'>locked?</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_locked_hash?'>locked_hash?</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="matches?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>matches?</strong>(key, hash) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


285
286
287</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/thread_safe/atomic_reference_cache_backend.rb', line 285</span>

<span class='kw'>def</span> <span class='id identifier rubyid_matches?'>matches?</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_hash'>hash</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_pure_hash'>pure_hash</span> <span class='op'>==</span> <span class='id identifier rubyid_hash'>hash</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_key?'>key?</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="pure_hash-instance_method">
  
    - (<tt>Object</tt>) <strong>pure_hash</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


289
290
291</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/thread_safe/atomic_reference_cache_backend.rb', line 289</span>

<span class='kw'>def</span> <span class='id identifier rubyid_pure_hash'>pure_hash</span>
  <span class='id identifier rubyid_hash'>hash</span> <span class='op'>&amp;</span> <span class='const'>HASH_BITS</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="try_await_lock-instance_method">
  
    - (<tt>Object</tt>) <strong>try_await_lock</strong>(table, i) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Spins a while if +LOCKED+ bit set and this node is the first of its bin,
and then sets +WAITING+ bits on hash field and blocks (once) if they are
still set. It is OK for this method to return even if lock is not
available upon exit, which enables these simple single-wait mechanics.</p>

<p>The corresponding signalling operation is performed within callers: Upon
detecting that +WAITING+ has been set when unlocking lock (via a failed
CAS from non-waiting +LOCKED+ state), unlockers acquire the
+cheap_synchronize+ lock and perform a +cheap_broadcast+.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/thread_safe/atomic_reference_cache_backend.rb', line 260</span>

<span class='kw'>def</span> <span class='id identifier rubyid_try_await_lock'>try_await_lock</span><span class='lparen'>(</span><span class='id identifier rubyid_table'>table</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_table'>table</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_i'>i</span> <span class='op'>&gt;=</span> <span class='int'>0</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_i'>i</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_table'>table</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='comment'># bounds check, TODO: why are we bounds checking?
</span>    <span class='id identifier rubyid_spins'>spins</span> <span class='op'>=</span> <span class='const'>SPIN_LOCK_ATTEMPTS</span>
    <span class='id identifier rubyid_randomizer'>randomizer</span> <span class='op'>=</span> <span class='id identifier rubyid_base_randomizer'>base_randomizer</span> <span class='op'>=</span> <span class='const'>Util</span><span class='op'>::</span><span class='const'>XorShiftRandom</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span>
    <span class='kw'>while</span> <span class='id identifier rubyid_equal?'>equal?</span><span class='lparen'>(</span><span class='id identifier rubyid_table'>table</span><span class='period'>.</span><span class='id identifier rubyid_volatile_get'>volatile_get</span><span class='lparen'>(</span><span class='id identifier rubyid_i'>i</span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_locked_hash?'>locked_hash?</span><span class='lparen'>(</span><span class='id identifier rubyid_my_hash'>my_hash</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_spins'>spins</span> <span class='op'>&gt;=</span> <span class='int'>0</span>
        <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_randomizer'>randomizer</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_randomizer'>randomizer</span> <span class='op'>&gt;&gt;</span> <span class='int'>1</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_even?'>even?</span> <span class='comment'># spin at random
</span>          <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_spins'>spins</span> <span class='op'>-=</span> <span class='int'>1</span><span class='rparen'>)</span> <span class='op'>==</span> <span class='int'>0</span>
            <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_pass'>pass</span> <span class='comment'># yield before blocking
</span>          <span class='kw'>else</span>
            <span class='id identifier rubyid_randomizer'>randomizer</span> <span class='op'>=</span> <span class='id identifier rubyid_base_randomizer'>base_randomizer</span> <span class='op'>=</span> <span class='const'>Util</span><span class='op'>::</span><span class='const'>XorShiftRandom</span><span class='period'>.</span><span class='id identifier rubyid_xorshift'>xorshift</span><span class='lparen'>(</span><span class='id identifier rubyid_base_randomizer'>base_randomizer</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_randomizer'>randomizer</span><span class='period'>.</span><span class='id identifier rubyid_zero?'>zero?</span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_cas_hash'>cas_hash</span><span class='lparen'>(</span><span class='id identifier rubyid_my_hash'>my_hash</span><span class='comma'>,</span> <span class='id identifier rubyid_my_hash'>my_hash</span> <span class='op'>|</span> <span class='const'>WAITING</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_force_aquire_lock'>force_aquire_lock</span><span class='lparen'>(</span><span class='id identifier rubyid_table'>table</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='rparen'>)</span>
        <span class='kw'>break</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="try_lock_via_hash-instance_method">
  
    - (<tt>Object</tt>) <strong>try_lock_via_hash</strong>(node_hash = hash) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


293
294
295
296
297
298
299
300
301</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/thread_safe/atomic_reference_cache_backend.rb', line 293</span>

<span class='kw'>def</span> <span class='id identifier rubyid_try_lock_via_hash'>try_lock_via_hash</span><span class='lparen'>(</span><span class='id identifier rubyid_node_hash'>node_hash</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_cas_hash'>cas_hash</span><span class='lparen'>(</span><span class='id identifier rubyid_node_hash'>node_hash</span><span class='comma'>,</span> <span class='id identifier rubyid_locked_hash'>locked_hash</span> <span class='op'>=</span> <span class='id identifier rubyid_node_hash'>node_hash</span> <span class='op'>|</span> <span class='const'>LOCKED</span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='kw'>yield</span>
    <span class='kw'>ensure</span>
      <span class='id identifier rubyid_unlock_via_hash'>unlock_via_hash</span><span class='lparen'>(</span><span class='id identifier rubyid_locked_hash'>locked_hash</span><span class='comma'>,</span> <span class='id identifier rubyid_node_hash'>node_hash</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="unlock_via_hash-instance_method">
  
    - (<tt>Object</tt>) <strong>unlock_via_hash</strong>(locked_hash, node_hash) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


307
308
309
310
311
312</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/thread_safe/atomic_reference_cache_backend.rb', line 307</span>

<span class='kw'>def</span> <span class='id identifier rubyid_unlock_via_hash'>unlock_via_hash</span><span class='lparen'>(</span><span class='id identifier rubyid_locked_hash'>locked_hash</span><span class='comma'>,</span> <span class='id identifier rubyid_node_hash'>node_hash</span><span class='rparen'>)</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_cas_hash'>cas_hash</span><span class='lparen'>(</span><span class='id identifier rubyid_locked_hash'>locked_hash</span><span class='comma'>,</span> <span class='id identifier rubyid_node_hash'>node_hash</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='id identifier rubyid_node_hash'>node_hash</span>
    <span class='id identifier rubyid_cheap_synchronize'>cheap_synchronize</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_cheap_broadcast'>cheap_broadcast</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Sun Mar  8 18:11:55 2015 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.2.0).
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57940973-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>